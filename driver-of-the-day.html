<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRL - Driver of the Day</title>

    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="VRL_logo_nove.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="index.html">
                        <img src="vrl_high_res.png" class="logo-img" alt="">
                    </a>
                </div>

                <div class="header-controls">
                    <button class="theme-switch" id="themeSwitch">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="mobile-menu-toggle" id="mobileMenuToggle">
                        <span></span><span></span><span></span>
                    </button>
                </div>

                <nav id="mobileNav">
                    <ul>
                        <li><a href="index.html">Dom≈Ø</a></li>
                        <li><a href="calendar.html">Kalend√°≈ô</a></li>
                        <li><a href="jezdci.html">Jezdci</a></li>
                        <li><a href="tymy.html">T√Ωmy</a></li>
                        <li><a href="okruh.html">Okruhy</a></li>
                        <li><a href="vysledky.html">V√Ωsledky</a></li>
                        <li><a href="prihlasky.html">P≈ô√≠hl√°≈°ky</a></li>
                        <li><a href="https://discord.gg/CMxscEUcRd" class="discord-btn"><i class="fab fa-discord"></i>
                                Discord</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <section class="hero">
        <div class="hero-fade"></div>
        <div class="container">
            <div class="hero-content">
                <h2>Driver of the Day</h2>
                <p>Hlasujte pro nejlep≈°√≠ho jezdce VRL z√°vodu</p>
            </div>
        </div>
    </section>

    <div class="container">
        <section class="season-info">
            <h2>Driver of the Day ‚Äì Sez√≥na 2</h2>
            <p>V√Ωsledky lze zobrazit v≈ædy ‚Ä¢ Hlasovat jde jen v aktivn√≠m oknƒõ</p>

            <div class="race-list" id="raceList"></div>
        </section>
    </div>

    <!-- Modal ‚Äì HLASOV√ÅN√ç -->
    <div id="votingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h3 id="modalRaceName">Hlasovat pro jezdce dne</h3>

            <div class="driver-selector">
                <select id="driverSelect">
                    <option value="">Vyberte jezdce</option>
                </select>
            </div>

            <button id="submitVote" class="btn">Odeslat hlas</button>
            <p style="opacity:0.7;margin-top:10px">Ka≈æd√© za≈ô√≠zen√≠ m≈Ø≈æe hlasovat pouze jednou.</p>
        </div>
    </div>

    <!-- Modal ‚Äì V√ùSLEDKY -->
    <div id="resultsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h3 id="resultsRaceName">V√Ωsledky hlasov√°n√≠</h3>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script src="js/global.js"></script>

    <script>
        // SPR√ÅVN√â HODNOTY PODLE TV√âHO OBR√ÅZKU
        const BIN_ID = "69275fffae596e708f72d9a1";  // Tv≈Øj prvn√≠ Bin
        const API_KEY = "$2a$10$F2bQxjNK9iS.c4XhkVnMJu/L.LdsAvJ5RFFUdr82YqHRVLomgoEla";  // Kl√≠ƒç k prvn√≠mu Binu
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        const drivers = [
            { number: 71, name: "Petr Stouhal", team: "Red Bull" },
            { number: 7, name: "Josef Kube≈°", team: "Ferrari" },
            { number: 2, name: "Zdenƒõk Pohlreich", team: "Mercedes" },
            { number: 1, name: "Maxim Heligr", team: "McLaren" },
            { number: 56, name: "Filip Kratochv√≠l", team: "Aston Martin" },
            { number: 24, name: "Viktor Koutn√Ω", team: "Alpine" },
            { number: 97, name: "Andrej Erdelsk√Ω", team: "Racing Bulls" },
            { number: 20, name: "Tom√°≈° Nov√°k", team: "Haas" },
            { number: 19, name: "J√°n Bub√°k", team: "Williams" },
            { number: 99, name: "Jakub Fabian", team: "Sauber" },
            { number: 13, name: "Oscar Andƒõl", team: "Red Bull" },
            { number: 28, name: "Lubo≈° Novotn√Ω", team: "Ferrari" },
            { number: 12, name: "Martin Klaboch", team: "Mercedes" },
            { number: 96, name: "Matƒõj Vacul√≠k", team: "McLaren" },
            { number: 4, name: "Max Novotn√Ω", team: "Williams" },
            { number: 11, name: "Oliver ƒåobrde", team: "Alpine" },
            { number: 67, name: "J√°chym Majvald", team: "Racing Bulls" },
            { number: 25, name: "Matƒõj ≈†vec", team: "Haas" },
            { number: 26, name: "Maty√°≈° Kasl", team: "Aston Martin" },
            { number: 66, name: "Oliver Stavaƒç", team: "Sauber" },
            { number: 21, name: "Adam Gallus", team: "Z√°loha" }
        ];

        const races = [
            { round: "R1", name: "Austr√°lie", date: "2025-09-09", track: "Melbourne Grand Prix Circuit" },
            { round: "R2", name: "Velk√° Brit√°nie", date: "2025-09-16", track: "Silverstone Circuit" },
            { round: "R3", name: "Bahrain", date: "2025-09-30", track: "Bahrain International Circuit" },
            { round: "R4", name: "Miami", date: "2025-10-07", track: "Miami International Autodrome" },
            { round: "R5", name: "Imola", date: "2025-10-14", track: "Autodromo Enzo e Dino Ferrari" },
            { round: "R6", name: "√Åzerb√°jd≈æ√°n", date: "2025-10-21", track: "Baku City Circuit" },
            { round: "R7", name: "Japonsko", date: "2025-11-04", track: "Suzuka" },
            { round: "R8", name: "Kanada", date: "2025-11-11", track: "Gilles Villeneuve" },
            { round: "R9", name: "Singapur", date: "2025-11-18", track: "Marina Bay" },
            { round: "R11", name: "≈†panƒõlsko", date: "2025-11-26", track: "Barcelona-Catalunya" },
            { round: "R10", name: "Belgie", date: "2025-12-02", track: "Spa-Francorchamps" },
            { round: "R11", name: "≈†panƒõlsko", date: "2025-12-16", track: "Barcelona-Catalunya" },
            { round: "R12", name: "Mexiko", date: "2026-01-06", track: "Hermanos Rodr√≠guez" },
            { round: "R13", name: "Braz√≠lie", date: "2026-01-20", track: "Interlagos" },
            { round: "R14", name: "USA", date: "2026-02-03", track: "COTA" },
            { round: "S1", name: "Sprint Reverse Rakousko", date: "2026-02-17", track: "Red Bull Ring" },
            { round: "R15", name: "Rakousko", date: "2026-02-17", track: "Red Bull Ring" },
            { round: "R16", name: "Monako", date: "2026-03-03", track: "Monaco" },
            { round: "R17", name: "It√°lie", date: "2026-03-10", track: "Monza" },
            { round: "R18", name: "Maƒèarsko", date: "2026-03-24", track: "Hungaroring" },
            { round: "R19", name: "Katar", date: "2026-04-07", track: "Losail" },
            { round: "R20", name: "Saudsk√° Ar√°bie", date: "2026-04-21", track: "Jeddah" },
            { round: "R21", name: "Abu Dhabi", date: "2026-04-28", track: "Yas Marina" }
        ];
        let currentRace = null;

        // === Funkce pro z√≠sk√°n√≠ device ID ===
        function getDeviceId() {
            let id = localStorage.getItem("vrl_device_id");
            if (!id) {
                id = "DEV_" + Math.random().toString(36).slice(2);
                localStorage.setItem("vrl_device_id", id);
            }
            return id;
        }

        function isVotingActive(r) {
            const now = new Date();
            const raceStart = new Date(`${r.date}T19:00:00`);
            const votingStart = new Date(raceStart.getTime() - 3600000);
            const votingEnd = new Date(raceStart.getTime() + 48 * 3600000);
            return now >= votingStart && now <= votingEnd;
        }

        function isVotingUpcoming(r) {
            const now = new Date();
            const raceStart = new Date(`${r.date}T19:00:00`);
            return now < raceStart.getTime() - 3600000;
        }

        function isRacePast(r) {
            const now = new Date();
            const raceStart = new Date(`${r.date}T19:00:00`);
            const votingEnd = new Date(raceStart.getTime() + 48 * 3600000);
            return now > votingEnd;
        }

        function getTimeUntilVotingStart(r) {
            const now = new Date();
            const raceStart = new Date(`${r.date}T19:00:00`);
            return (raceStart.getTime() - 3600000) - now;
        }

        function formatTime(ms) {
            const d = Math.floor(ms / 86400000);
            const h = Math.floor((ms % 86400000) / 3600000);
            const m = Math.floor((ms % 3600000) / 60000);
            if (d > 0) return `${d}d ${h}h ${m}m`;
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }

        // === Naƒçten√≠ hlas≈Ø z JsonBin ===
        async function getVotes(r) {
            try {
                console.log("Naƒç√≠t√°m data z JSON Bin...");
                const res = await fetch(API_URL, {
                    headers: { "X-Master-Key": API_KEY }
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const json = await res.json();
                console.log("Data naƒçtena:", json);
                
                const data = json.record;

                return {
                    votes: data.votes[r.date] || {},
                    devices: data.devices[r.date] || {}
                };
            } catch (e) {
                console.error("Chyba p≈ôi naƒç√≠t√°n√≠ JSON Bin:", e);
                return { votes: {}, devices: {} };
            }
        }

        async function displayRaceList() {
            const list = document.getElementById("raceList");
            list.innerHTML = "";

            for (const r of races) {
                const voting = isVotingActive(r);
                const upcoming = isVotingUpcoming(r);
                const past = isRacePast(r);
                const store = await getVotes(r);
                const voted = !!store.devices[getDeviceId()];

                let status = "";
                let buttons = "";

                if (voting) {
                    status = voted ? "‚úÖ U≈æ jste hlasovali" : "üîµ Hlasov√°n√≠ prob√≠h√°";
                    if (!voted) {
                        buttons = `<button class="btn btn-vote vote-active" onclick="openVote('${r.date}')">Hlasovat</button>`;
                    }
                    buttons += `<button class="btn btn-results" onclick="openResults('${r.date}')">V√Ωsledky</button>`;
                } else if (upcoming) {
                    status = `üü° Zaƒç√≠n√° za ${formatTime(getTimeUntilVotingStart(r))}`;
                    buttons = `<button class="btn btn-vote vote-inactive" disabled>Hlasovat</button>
                              <button class="btn btn-results" onclick="openResults('${r.date}')">V√Ωsledky</button>`;
                } else if (past) {
                    // Z√°vody, kter√© se ji≈æ jely - pouze tlaƒç√≠tko V√Ωsledky
                    status = "‚úî Hlasov√°n√≠ ukonƒçeno";
                    buttons = `<button class="btn btn-results" onclick="openResults('${r.date}')">V√Ωsledky</button>`;
                }

                list.innerHTML += `
                <div class="race-item">
                    <div class="race-header">
                        <h3>${r.round} ‚Äì ${r.name}</h3>
                        <div>${status}</div>
                    </div>
                    <p><strong>Tra≈•:</strong> ${r.track}</p>
                    <p><strong>Datum:</strong> ${new Date(r.date).toLocaleDateString("cs-CZ")} v 19:00</p>
                    <div class="race-actions">${buttons}</div>
                </div>`;
            }
        }

        function populateDrivers() {
            const sel = document.getElementById("driverSelect");
            sel.innerHTML = "<option value=''>Vyber jezdce</option>";
            drivers.forEach(d => sel.innerHTML += `<option value="${d.number}">${d.number} ‚Äì ${d.name} (${d.team})</option>`);
        }

        function openVote(date) {
            currentRace = races.find(r => r.date === date);
            document.getElementById("modalRaceName").innerText = "Hlasovat ‚Äì " + currentRace.name;
            populateDrivers();
            document.getElementById("votingModal").style.display = "block";
        }

        // === Zobrazen√≠ v√Ωsledk≈Ø ===
        async function openResults(date) {
            const r = races.find(x => x.date === date);
            const modal = document.getElementById("resultsModal");
            const out = document.getElementById("resultsContainer");

            const data = await getVotes(r);
            const votes = data.votes;

            document.getElementById("resultsRaceName").innerText = "V√Ωsledky ‚Äì " + r.name;

            if (!votes || Object.keys(votes).length === 0) {
                out.innerHTML = "<p>Zat√≠m nikdo nehlasoval.</p>";
                modal.style.display = "block";
                return;
            }

            const sorted = Object.entries(votes)
                .map(([num, v]) => {
                    const d = drivers.find(x => x.number == num);
                    return { ...d, votes: v };
                })
                .sort((a, b) => b.votes - a.votes);

            out.innerHTML = sorted.map((d, i) => `
                <div class="result-row">
                    <div>${i + 1}.</div>
                    <div><strong>${d.name}</strong> (#${d.number})</div>
                    <div class="result-bar-container"><div class="result-bar" style="width:${d.votes * 10}px"></div></div>
                    <div>${d.votes} hlas≈Ø</div>
                </div>
            `).join("");

            modal.style.display = "block";
        }

        function closeModals() {
            document.getElementById("votingModal").style.display = "none";
            document.getElementById("resultsModal").style.display = "none";
        }

        // === Odesl√°n√≠ hlasu - OPRAVEN√Å VERZE ===
        document.getElementById("submitVote").onclick = async function () {
            const num = document.getElementById("driverSelect").value;
            if (!num) return alert("Vyber jezdce!");

            try {
                console.log("Zaƒç√≠n√°m proces hlasov√°n√≠...");

                // Naƒç√≠st aktu√°ln√≠ data
                const res = await fetch(API_URL, {
                    headers: { "X-Master-Key": API_KEY }
                });
                
                console.log("Stav odpovƒõdi p≈ôi ƒçten√≠:", res.status);
                
                if (!res.ok) {
                    throw new Error(`Chyba p≈ôi naƒç√≠t√°n√≠: ${res.status}`);
                }
                
                const json = await res.json();
                console.log("Data naƒçtena z JSON Bin:", json);
                
                let allData = json.record;

                // Inicializovat strukturu, pokud neexistuje
                if (!allData) {
                    console.log("AllData je pr√°zdn√©, inicializuji...");
                    allData = {};
                }
                if (!allData.votes) allData.votes = {};
                if (!allData.devices) allData.devices = {};
                if (!allData.votes[currentRace.date]) allData.votes[currentRace.date] = {};
                if (!allData.devices[currentRace.date]) allData.devices[currentRace.date] = {};

                const dev = getDeviceId();
                console.log("Device ID:", dev);

                // Kontrola, zda u≈æivatel ji≈æ hlasoval
                if (allData.devices[currentRace.date][dev]) {
                    return alert("U≈æ jste hlasovali!");
                }

                // P≈ôid√°n√≠ hlasu
                allData.votes[currentRace.date][num] = (allData.votes[currentRace.date][num] || 0) + 1;
                console.log("Hlas p≈ôid√°n pro jezdce ƒç.", num);

                // Oznaƒçen√≠ za≈ô√≠zen√≠ jako odhlasovan√©ho
                allData.devices[currentRace.date][dev] = true;

                console.log("Data k odesl√°n√≠:", allData);

                // Ulo≈æit zpƒõt
                const putRes = await fetch(API_URL, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Master-Key": API_KEY
                    },
                    body: JSON.stringify(allData)
                });

                console.log("Stav odpovƒõdi p≈ôi ukl√°d√°n√≠:", putRes.status);

                if (!putRes.ok) {
                    throw new Error(`Chyba p≈ôi ukl√°d√°n√≠: ${putRes.status}`);
                }

                const putJson = await putRes.json();
                console.log("Odpovƒõƒè po ulo≈æen√≠:", putJson);

                closeModals();
                displayRaceList();
                alert("Hlas odesl√°n.");
            } catch (error) {
                console.error("Chyba p≈ôi odes√≠l√°n√≠ hlasu:", error);
                alert("Do≈°lo k chybƒõ p≈ôi odes√≠l√°n√≠ hlasu: " + error.message);
            }
        };

        displayRaceList();
        setInterval(displayRaceList, 60000);
    </script>

</body>

</html>
